<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Photo Enhancer</title>
    <style>
      :root {
        color: #0b0b0f;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        margin: 0;
        padding: 16px;
        background: #f6f8fb;
      }

      main {
        max-width: 520px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      }

      h2 {
        margin: 0 0 12px;
        font-size: 18px;
      }

      .hint {
        font-size: 12px;
        color: #6c768a;
        margin-bottom: 12px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .card {
        border-radius: 12px;
        background: #f2f4fb;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .card h3 {
        margin: 0;
        font-size: 14px;
      }

      .img-wrapper {
        border-radius: 10px;
        overflow: hidden;
        background: #dde3f0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 140px;
        text-align: center;
        font-size: 12px;
        color: #6c768a;
      }

      img {
        max-width: 100%;
        display: block;
      }

      .status {
        margin-top: 10px;
        font-size: 12px;
      }

      .status.error {
        color: #d92d20;
      }

      .status.success {
        color: #067647;
      }

      .buttons {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .buttons a {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        text-decoration: none;
        background: #111bf5;
        color: #fff;
      }
    </style>
  </head>

  <body>
    <main>
      <h2>Photo Enhancer</h2>

      <div class="hint">
        This tool enhances photos from a <b>public https image URL</b>.
        <br />
        If your image is local, upload it to a hosting service first and provide
        a direct https link.
      </div>

      <div class="grid">
        <div class="card">
          <h3>Original</h3>
          <div class="img-wrapper" id="original-box">
            <span id="original-placeholder">Waiting for public image URL…</span>
            <img id="original-img" style="display: none" />
          </div>
        </div>

        <div class="card">
          <h3>Enhanced</h3>
          <div class="img-wrapper" id="enhanced-box">
            <span id="enhanced-placeholder">Enhancing…</span>
            <img id="enhanced-img" style="display: none" />
          </div>
        </div>
      </div>

      <div class="status" id="status-text"></div>
      <div class="buttons" id="buttons"></div>
    </main>

    <script type="module">
      const originalImg = document.getElementById("original-img");
      const enhancedImg = document.getElementById("enhanced-img");
      const originalPlaceholder = document.getElementById(
        "original-placeholder"
      );
      const enhancedPlaceholder = document.getElementById(
        "enhanced-placeholder"
      );
      const statusText = document.getElementById("status-text");
      const buttons = document.getElementById("buttons");

      function getPayload(raw) {
        if (!raw) return null;
        return raw.structuredContent ?? raw;
      }

      function clearUI() {
        originalImg.style.display = "none";
        enhancedImg.style.display = "none";
        originalPlaceholder.style.display = "block";
        enhancedPlaceholder.style.display = "block";
        buttons.innerHTML = "";
        statusText.textContent = "";
        statusText.className = "status";
      }

      function isHttps(url) {
        return typeof url === "string" && url.startsWith("https://");
      }

      function renderFromToolOutput(rawToolOutput) {
        const data = getPayload(rawToolOutput);
        if (!data) return;

        clearUI();

        const { originalUrl, enhancedUrl, status, message } = data;

        if (isHttps(originalUrl)) {
          originalImg.src = originalUrl;
          originalImg.style.display = "block";
          originalPlaceholder.style.display = "none";

          const link = document.createElement("a");
          link.href = originalUrl;
          link.target = "_blank";
          link.textContent = "Open original";
          buttons.appendChild(link);
        }

        if (isHttps(enhancedUrl)) {
          enhancedImg.src = enhancedUrl;
          enhancedImg.style.display = "block";
          enhancedPlaceholder.style.display = "none";

          const link = document.createElement("a");
          link.href = enhancedUrl;
          link.target = "_blank";
          link.textContent = "Open enhanced";
          buttons.appendChild(link);
        }

        if (status || message) {
          statusText.textContent =
            status === "COMPLETED"
              ? "Photo enhanced successfully."
              : message || status;

          statusText.className =
            "status " +
            (status === "COMPLETED" ? "success" : "error");
        }
      }

      // Initial render
      renderFromToolOutput(window.openai?.toolOutput);

      // Listen for updates
      window.addEventListener(
        "openai:set_globals",
        (event) => {
          const globals = event.detail?.globals;
          if (!globals?.toolOutput) return;
          renderFromToolOutput(globals.toolOutput);
        },
        { passive: true }
      );
    </script>
  </body>
</html>
