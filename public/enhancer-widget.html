<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Photo Enhancer</title>
    <style>
      :root {
        color: #0b0b0f;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      body {
        margin: 0;
        padding: 16px;
        background: #f6f8fb;
      }
      main {
        max-width: 520px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
      }
      h2 {
        margin: 0 0 12px;
        font-size: 18px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .card {
        border-radius: 12px;
        background: #f2f4fb;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .card h3 {
        margin: 0;
        font-size: 14px;
      }
      .img-wrapper {
        border-radius: 10px;
        overflow: hidden;
        background: #dde3f0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 120px;
      }
      img {
        max-width: 100%;
        display: block;
      }
      .status {
        margin-top: 8px;
        font-size: 12px;
        color: #6c768a;
      }
      .buttons {
        margin-top: 8px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .buttons a {
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: none;
        text-decoration: none;
        background: #111bf5;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <main>
      <h2>Photo Enhancer</h2>
      <div class="grid">
        <div class="card">
          <h3>Original</h3>
          <div class="img-wrapper" id="original-box">
            <span id="original-placeholder">Waiting for image...</span>
            <img id="original-img" style="display: none" />
          </div>
        </div>
        <div class="card">
          <h3>Enhanced</h3>
          <div class="img-wrapper" id="enhanced-box">
            <span id="enhanced-placeholder">Enhancing...</span>
            <img id="enhanced-img" style="display: none" />
          </div>
        </div>
      </div>
      <div class="status" id="status-text"></div>
      <div class="buttons" id="buttons"></div>
    </main>

    <script type="module">
      const originalImg = document.getElementById("original-img");
      const enhancedImg = document.getElementById("enhanced-img");
      const originalPlaceholder = document.getElementById("original-placeholder");
      const enhancedPlaceholder = document.getElementById("enhanced-placeholder");
      const statusText = document.getElementById("status-text");
      const buttons = document.getElementById("buttons");

      function renderFromToolOutput(toolOutput) {
        if (!toolOutput) return;
        const { originalUrl, enhancedUrl, status, message } = toolOutput;

        buttons.innerHTML = "";

        if (originalUrl) {
          originalImg.src = originalUrl;
          originalImg.style.display = "block";
          originalPlaceholder.style.display = "none";

          const link = document.createElement("a");
          link.href = originalUrl;
          link.target = "_blank";
          link.textContent = "Open original";
          buttons.appendChild(link);
        }

        if (enhancedUrl) {
          enhancedImg.src = enhancedUrl;
          enhancedImg.style.display = "block";
          enhancedPlaceholder.style.display = "none";

          const link = document.createElement("a");
          link.href = enhancedUrl;
          link.target = "_blank";
          link.textContent = "Open enhanced";
          buttons.appendChild(link);
        }

        if (status || message) {
          statusText.textContent = `${status ?? ""} ${message ?? ""}`.trim();
        } else {
          statusText.textContent = "";
        }
      }

      // 初始渲染：ChatGPT 把 toolOutput 注入到 window.openai.toolOutput :contentReference[oaicite:2]{index=2}
      renderFromToolOutput(window.openai?.toolOutput);

      // 当有新的工具结果时，会通过 openai:set_globals 事件更新 :contentReference[oaicite:3]{index=3}
      window.addEventListener(
        "openai:set_globals",
        (event) => {
          const globals = event.detail?.globals;
          if (!globals?.toolOutput) return;
          renderFromToolOutput(globals.toolOutput);
        },
        { passive: true }
      );
    </script>
  </body>
</html>
